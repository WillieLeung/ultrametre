<!doctype html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Ultrametre</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;800&display=swap" rel="stylesheet">
    <style>
        :root { --bg1: #071022; --bg2: #07182a; --accent1: #5eead4; --accent2: #60a5fa; }
        body { font-family: 'Inter', sans-serif; background: linear-gradient(135deg, var(--bg1), var(--bg2)); color: #e8eef7; padding: 20px; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; max-width: 800px; }
        .card { background: rgba(255,255,255,0.03); padding: 15px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.05); }
        .big { font-size: 32px; font-weight: 800; color: var(--accent1); }
        button { padding: 10px 20px; border-radius: 8px; border: none; font-weight: 700; cursor: pointer; margin: 5px; transition: 0.2s; }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-primary { background: linear-gradient(90deg, #60a5fa, #5eead4); color: #071025; }
        .btn-secondary { background: #334155; color: white; }
        .btn-danger { background: #fb7185; color: white; }
        .status-dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; margin-right: 5px; }
        .running { background: #34d399; }
        .stopped { background: #ef4444; }
        #raw { font-family: monospace; font-size: 12px; color: #9fb0c9; height: 60px; overflow-y: auto; background: rgba(0,0,0,0.2); padding: 10px; border-radius: 8px; }
    </style>
</head>
<body>
    <h2>Ultrametre Dashboard</h2>
    <div class="grid">
        <div class="card"><div class="label">Bridge Status</div><p id="bridgeStatus"><span class="status-dot stopped"></span> Disconnected</p></div>
        <div class="card"><div class="label">Last Logged (from Arduino)</div><div id="loggedDist" class="big">0 cm</div></div>
        <div class="card" style="grid-column: span 2;"><div class="label">Live Serial Feed</div><div id="raw">Waiting for data...</div></div>
    </div>

    <div style="margin-top: 20px;">
        <button id="startBtn" class="btn-primary" onclick="controlBridge('start')">Start Bridge</button>
        <button id="stopBtn" class="btn-danger" onclick="controlBridge('stop')" disabled>Stop Bridge</button>
    </div>

    <div class="card" style="margin-top: 20px; max-width: 800px;">
        <div class="label">Robot Controls</div>
        <input id="amt" type="number" step="0.001" value="0.01" style="padding: 10px; border-radius: 5px; border: none; width: 100px;">
        <button class="btn-primary" onclick="sendSol()">ðŸ’¸ Send SOL & Launch</button>
        <button class="btn-secondary" onclick="fetchData()">ðŸ”„ Fetch Saved Dist</button>
        <button class="btn-danger" onclick="clearData()">ðŸ§¹ Clear Journey</button>
        <p id="txResult" style="font-size: 12px; color: #9fb0c9; margin-top: 10px;"></p>
    </div>

    <script>
        const events = new EventSource('/bridge/events');
        
        events.addEventListener('serial', (e) => {
            const data = JSON.parse(e.data);
            const text = data.text.trim();
            if(!text) return;

            document.getElementById('raw').innerText = text;

            // Look for TOTAL_DISTANCE_TRAVELLED: XXX
            let m = text.match(/TOTAL_DISTANCE_TRAVELLED:\s*([-+]?\d+(?:\.\d+)?)/i);
            if (m) {
                document.getElementById('loggedDist').innerText = m[1] + ' cm';
            }

            if (text.includes("DISTANCE_RESET")) {
                document.getElementById('loggedDist').innerText = '0 cm';
            }
        });

        events.addEventListener('status', (e) => {
            const data = JSON.parse(e.data);
            updateUI(data.running);
        });

        async function controlBridge(action) {
            const res = await fetch(`/bridge/${action}`, { method: 'POST' });
            const statusRes = await fetch('/bridge/status');
            const status = await statusRes.json();
            updateUI(status.running);
        }

        async function fetchData() {
            document.getElementById('loggedDist').innerText = 'Fetching...';
            await fetch('/bridge/fetch-data', { method: 'POST' });
        }

        async function clearData() {
            if(!confirm("Reset Arduino distance to 0?")) return;
            await fetch('/bridge/clear', { method: 'POST' });
        }

        async function sendSol() {
            const resEl = document.getElementById('txResult');
            resEl.innerText = "Processing Transaction...";
            try {
                const res = await fetch('/bridge/send', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ amount: document.getElementById('amt').value })
                });
                const data = await res.json();
                resEl.innerText = data.ok ? "âœ“ Sent: " + data.signature.slice(0,10) : "Error: " + data.error;
            } catch (e) { resEl.innerText = "Failed to connect."; }
        }

        function updateUI(running) {
            document.getElementById('startBtn').disabled = running;
            document.getElementById('stopBtn').disabled = !running;
            document.getElementById('bridgeStatus').innerHTML = running ? 
                '<span class="status-dot running"></span> Bridge Connected' : 
                '<span class="status-dot stopped"></span> Bridge Stopped';
        }

        fetch('/bridge/status').then(r => r.json()).then(d => updateUI(d.running));
    </script>
</body>
</html>